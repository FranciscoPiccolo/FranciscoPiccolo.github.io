---
title: "Econometria, validanto autocorrelação de resíduos"
output: html_document
---

Na área de econometria busca-se encontrar relações de causalidade entre variáveis econômicas, onde estas relações são determinadas pelo grau de correlação entre as variáveis estudadas. O ferramental frequentemente utilizado para isso é a regressão, podendo ser linear simples ou múltipla, regressão com variáveis *dummy* ou regressão logística. 

Ao utilizar a regressão, uma das hipóteses que validam as conclusões tiradas do modelo é a de não existência de autocorrelação dos resíduos gerados na criação da reta de regressão. Por esta ser uma premissa chave para a validade do modelo, há testes estatísticos formais que auxiliam na comprovação desta premissa. Neste post irei comentar sobre alguns destes testes e como eles podem ser implementados no R.

Pacotes utilizados para execução das atividades
```{r,eval=T,include=T,echo=T,warning=F,message=F}
library(tidyverse)
library(lmtest)
library(corrplot)
library(readxl)
library(gridExtra)

theme_set(theme_light())
```

Objetivos: desenvolver gráficos para analisar autocorrelação de resíduos, aplicar o teste Durbin Watson, aplicar o teste Godfrey e aplicar o teste Q (a.k.a Ljung–Box test).

#### **Primeira parte**

Base de dados com valores do preço da cana de açucar e área plantada (em hectares), por período analisado. Deseja-se avaliar a elasticidade da área plantada com relação ao preço, a partir de uma série histórica. O modelo é descrito abaixo:

$$ lnY_t = \beta_1+\beta_2 (lnX_t) + U_t $$

Onde: 

$Y_t$ = área plantada no ano t (em hectares)

$X_t$ = preço no ano t

Base de dados para o exercício (apenas as primeiras 5 linhas):

```{r,eval=T,include=F,echo=F}
dados <- readxl::read_excel("C:/Users/francisco.piccolo/Downloads/04_Exercycio_Autocorrelayyo_Dados_Cana.xlsx")

dados %>% 
  mutate(
    periodo = Período,
    area = Área,
    valor = `Preço da Cana de Açúcar`
  ) -> dados_2 
```

```{r,eval=T,include=T,echo=F}
dados_2 %>%
  select(periodo,area,valor) %>% 
  head()
```

Gráfico de dispersão (área plantada x preço da cana)

```{r,eval=T,include=T,echo=F,fig.align='center',fig.width=5,fig.height=3}
dados %>% 
  ggplot(aes(x=Área,y=`Preço da Cana de Açúcar`))+
  geom_point()+
  geom_smooth()+
  labs(
    title = "Relação entre Área e Preço da Cana (em log)",
    subtitle= "Existe correlação, indicando que há elasticidade na oferta",
    x = "Área de plantação",
    y = "Preço de mercado"
  )
```


```{r,eval=T,include=T,echo=F,fig.align='center',fig.width=5,fig.height=3}
dados %>% 
  ggplot(aes(x=Período,y=Área,group=1))+
  geom_line()+
  geom_smooth()+
  labs(
    title = "Área plantada por período (t)",
    x = "Período",
    y = "Área plantada"
  )
```

1. Verifique se há autocorrelação serial dos erros. Comente o diagrama de dispersão e o correlograma.

R: Primeiro, deve-se criar o modelo de regressão para depois gerar os erros. O modelo é resumido abaixo:

$$ lnY_t = \beta_1+\beta_2 (lnX_t) + U_t $$

R² = 64.4%
Adjusted R² = 63.3%

Equação:  $lnY_t = 2.54 + 479.18 (lnX_t) + U_t$

```{r,eval=T,include=F,echo=F}
lr <- lm(area~valor,data = dados_2)

summary(lr)

residual <- residuals(lr)
```

Abaixo há uma amostra dos resíduos gerados pelo modelo:

```{r,eval=T,include=F,echo=F}
df <- cbind(dados_2, residual)
```

```{r,eval=T,include=T,echo=F}
df %>% 
  select(periodo,area,valor,residual) %>% 
  head()
```

Após gerar os resíduos, pode-se analisar se há autocorrelação. Os gráficos abaixo mostram se há este comportamento.

```{r,eval=T,include=T,echo=F,warning=F,message=F,fig.align='center',fig.width=5,fig.height=3}
df %>% 
  ggplot(aes(x=periodo,y=residual,group=1))+
  geom_line()+
  geom_hline(lty=2,yintercept = 0,size=.2,color="red")+
  labs(
    title = "Resíduos ao longo dos períodos analisados",
    subtitle = "Não há correlação serial dos resíduos",
    x = "Período",
    y = "Valor dos resíduos"
  )
```

```{r,eval=T,include=T,echo=F,warning=F,message=F,fig.align='center',fig.width=5,fig.height=3}
g1 <- df %>% 
  select(
    residual
  ) %>% 
  mutate(
    residual_lag_1 = lag(residual,1),
    residual_lag_2 = lag(residual,2)
  ) %>% 
  filter(!is.na(residual_lag_2)) %>% 
  ggplot()+
  geom_point(aes(x=residual,y=residual_lag_1),color="dark orange")+
  geom_hline(lty=2,yintercept = 0,size=.2,color="red")+
  geom_vline(lty=2,xintercept = 0,size=.2,color="red")+
  labs(
    title = "Resíduos (t) vs Resíduos (t-1)",
    subtitle = "Não há autocorrelação serial",
    x = "Resíduos (t)",
    y = "Resíduos (t-1)"
  )

g2 <- df %>% 
  select(
    residual
  ) %>% 
  mutate(
    residual_lag_1 = lag(residual,1),
    residual_lag_2 = lag(residual,2)
  ) %>% 
  filter(!is.na(residual_lag_2)) %>% 
  ggplot()+
  geom_point(aes(x=residual,y=residual_lag_2),color="blue")+
  geom_hline(lty=2,yintercept = 0,size=.2,color="red")+
  geom_vline(lty=2,xintercept = 0,size=.2,color="red")+
  labs(
    title = "Resíduos (t) vs Resíduos (t-2)",
    subtitle = "Não há autocorrelação serial",
    x = "Resíduos (t)",
    y = "Resíduos (t-2)"
  )

gridExtra::grid.arrange(g1,g2,ncol=2)
```

Aparentemente não há autocorrelação entre os resíduos. Porém, para garantir, é interessante usar testes estatísticos formais, como o Durbin Watson ou Godfrey.

2. Aplique o teste de Durbin Watson, escrevendo as hipóteses e testando a autocorrelação. Use um nível de significância de 5%.

R: Abaixo há a aplicação do teste DW.

```{r,eval=T,include=T,echo=F,warning=F,message=F}
lmtest::dwtest(lr)
```

De maneira resumida, o valor-p foi de 0.04089 e o valor d, 1.91822. Neste teste, usa-se o valor d para gerar a conclusão do teste. Antes, é preciso trazer os intervalos para comparação deste valor d. Para encontrar o intervalor, use a [tablea](http://www.portalaction.com.br/analise-de-regressao/33-diagnostico-de-independencia) específica do teste.

De acordo com a tabela, sabendo a quantidade de registros (n = 33), a significância (0.05) e o nível de liberdade (degrees of freedom = 1) que é o número de variáveis independentes, pode-se achar os valores **dl** e **du**. Para este exercício tem-se:

**dl** = 1.35

**du** = 1.49

Sabendo que dw = 1.47 e os critérios do teste, chega-se a uma inconclusão. O teste não consegue concluir se há autocorrelação serial dos resíduos com defasagem de um período (t). Na zona de indecisão não se pode nem aceitar ou rejeitar H0.

3. Aplique o teste Breusch Godfrey (a.k.a teste LM) escrevendo as hipóteses. Teste a autocorrelação com nível de significância de 5% e escreva a conclusão.

4. Aplique o teste Q e comente os resultados.

```{r,eval=T,echo=F,include=F,warning=F,message=F}
Box.test(residual,lag = 2,type = c("Box-Pierce", "Ljung-Box"), fitdf = 0)
```










