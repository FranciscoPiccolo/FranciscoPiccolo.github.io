<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>Posts on Glass Frog</title>
        <link>/posts/</link>
        <description>Recent content in Posts on Glass Frog</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>en-us</language>
        <lastBuildDate>Mon, 20 Jan 2020 00:00:00 +0000</lastBuildDate>
        <atom:link href="/posts/index.xml" rel="self" type="application/rss+xml" />
        
        <item>
            <title>Global Immigration Outlook using wbstats R package</title>
            <link>/posts/2020/01/global-immigration-outlook-using-wbstats-r-package/</link>
            <pubDate>Mon, 20 Jan 2020 00:00:00 +0000</pubDate>
            
            <guid>/posts/2020/01/global-immigration-outlook-using-wbstats-r-package/</guid>
            <description>Imigration is a central theme on political debates for presidential elections nowadays, creating a lot of controversies and also hope for many people. This social event is increasingly calling more attention, both Syria conflict and the weaknesses of the Venezuelan economy that sent millions to seek other place to live surpreended politicians, that didn’t get ready earlier to obtain the benefits that migration flow could generate.
Because of the theme’s relevance, in November-2019 The Economist made a special report about immigration, aiming to clarify the current situation, answer some questions about the impact of immigrants on host countries and also present some success cases of countries that are obtaining advantages by the immigration flow.</description>
            <content type="html"><![CDATA[


<p>Imigration is a central theme on political debates for presidential elections nowadays, creating a lot of controversies and also hope for many people. This social event is increasingly calling more attention, both Syria conflict and the weaknesses of the Venezuelan economy that sent millions to seek other place to live surpreended politicians, that didn’t get ready earlier to obtain the benefits that migration flow could generate.</p>
<p>Because of the theme’s relevance, in November-2019 <a href="https://www.economist.com/printedition/2019-11-16">The Economist</a> made a special report about immigration, aiming to clarify the current situation, answer some questions about the impact of immigrants on host countries and also present some success cases of countries that are obtaining advantages by the immigration flow.</p>
<p>I’ve really enjoyed the theme and the researches that were writen by The Economist’s correspondents, thus I decided to write a post to present the main conclusions of the studies and also complement them with additional data about immigration around the world. For this task I’ll access World Bank’s database using the R package wbstats, an API that allows you to connect to the institution’s database.</p>
<p>The following image is from one of the magazine’s reports.</p>
<p><img src="/images/2020-01-09_imigration_post.png" /></p>
<div id="main-conclusions-of-the-report" class="section level2">
<h2><strong>Main conclusions of the report</strong></h2>
<ol style="list-style-type: decimal">
<li><p>People that successfully migrate from a poor country to a rich one increase their income between 3 to 6 times, because rich countries have better institutions, capital alocation and modern companies.</p></li>
<li><p>If everone that wanted immigration were allowed to, World’s GDP could increase in 100%.</p></li>
<li><p>Immigrants are more likely to open their own business because they percept unatended demands easier than local residents and also they find alternative solutions to existent problems on the country that they enter.</p></li>
<li><p>The main “problem” with immigration is the cultural change, that occurs speedly in specific places because immigrants tend to cluster in certain locals. In addition of being the main problem, it’s a tough condition to measure, then it’s difficult to be contested.</p></li>
<li><p>People are more tolerant to immigration flow in their countries when they feel that their government are in charge of the frontier, allowing people qualified that will add to local society. In other words, people are more receptive if they feel that the process is under control.</p></li>
<li><p>Imigratns often share their income with their families that have stayed on the country and this shared income is called <a href="https://www.ted.com/talks/dilip_ratha_the_hidden_force_in_global_economics_sending_money_home">remitances</a>. Remitances already is the main source of external investment in certain poor countries. This flow of money has high potential of impacts, because it goes straight to the pocket of people that are in need and also this investment doesn’t carry the risk of being misplaced by corruption. Remitances represent more than 10% of GDP for 28 countries.</p></li>
</ol>
</div>
<div id="immigration-outlook" class="section level2">
<h2><strong>Immigration Outlook</strong></h2>
<p>After understanding some aspects of immigration, we can analyze some data from World Bank in order to dive a little deep on this theme. For this task I’ll use the following packages:</p>
<pre class="r"><code>library(tidyverse)      # data science and data manipulation packages
library(wbstats)        # World Bank API

theme_graph &lt;- function(){
  theme(
    plot.title = element_text(size = 16),
    plot.subtitle = element_text(size = 12),
    plot.caption = element_text(face = &quot;italic&quot;, size = 9),
    axis.text = element_text(size = 9),
    axis.title = element_text(face = &quot;italic&quot;, size = 9),
    strip.background = element_rect(fill = &quot;grey&quot;),
    strip.text = element_text(face = &quot;bold&quot;),
    legend.title = element_blank(),
    legend.position = &quot;bottom&quot;
  )
}</code></pre>
<p>The first thing the I would like to know about this theme is the population considered immigrant by the institution, as well as the evolution of this metric during the years. In order to access this data, we just need to call the wbstats package with the code that represent the desired metric.</p>
<pre class="r"><code># Creating a variable with the data.frame of the requested data
migrants_pop &lt;- wbstats::wb(indicator = &quot;SM.POP.TOTL&quot;,
                              country = &quot;countries_only&quot;,
                              startdate = 1980,
                              enddate = 2019)</code></pre>
<p>After requesting the data, it’s possible to analyze the immigration population during the years.</p>
<pre class="r"><code>migrants_pop %&gt;% 
  group_by(date) %&gt;% 
  summarise(immigrants = sum(value)) %&gt;% 
  ggplot()+
  geom_line(mapping = aes(x = date, y = immigrants, group = 1), 
            size = .5, 
            color = &quot;dark orange&quot;,
            alpha = .6)+
  geom_point(mapping = aes(x = date, y = immigrants),
             color = &quot;dark orange&quot;)+
  scale_y_continuous(labels = scales::comma)+
  theme_graph()+
  labs(title = &quot;Immigrant&#39;s population during the years&quot;,
       x = &quot;&quot;,
       y = &quot;&quot;)</code></pre>
<p><img src="/posts/2020-01-20-imigration-data-analysis_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<p>The dataset goes untill 2015 with a population of 250 millions. That’s more than Brazil’s population. Moving forward, let’s see which countries have the highest share of immigrants living on their territory. The next visualization will present the 20 countries with the highest rate of immigrants on their population. Probably Canada and Australia will be well positioned.</p>
<p>For this visualization, we’ll need bring data about country population in order to join with the immigrant population. This metric will consider the share in 2015 only.</p>
<pre class="r"><code># Bringing population data from world bank
population &lt;- wbstats::wb(indicator = &quot;SP.POP.TOTL&quot;,
                          country = &quot;countries_only&quot;)</code></pre>
<pre class="r"><code># Joining both datasets
migrants_pop %&gt;% 
  filter(date == &quot;2015&quot;) %&gt;% 
  select(country, date, value) %&gt;% 
  inner_join(population, by = c(&quot;country&quot; = &quot;country&quot;, &quot;date&quot; = &quot;date&quot;)) %&gt;%
  mutate(share_immigrants = round(value.x/value.y, digits = 4)) %&gt;% 
  filter(value.y &gt;= 10000000) %&gt;% 
  arrange(desc(share_immigrants)) %&gt;% 
  head(20) %&gt;% 
  mutate(country = fct_reorder(country, share_immigrants)) %&gt;% 
  ggplot()+
  geom_col(mapping = aes(x = country, y = share_immigrants),
           fill = &quot;dark orange&quot;,
           alpha = .6)+
  scale_y_continuous(labels = scales::percent)+
  theme_graph()+
  labs(title = &quot;County rank by imigration share over population&quot;,
       x = &quot;&quot;,
       y = &quot;% of imigrants over the population&quot;)+
  coord_flip()</code></pre>
<p><img src="/posts/2020-01-20-imigration-data-analysis_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>I didn’t know Saudi Arabia would be the first. This <a href="https://www.thestreet.com/personal-finance/countries-with-most-immigrants">article</a> enforce this number. As I removed countries with less than 10 million hbitants, I’ve probably removed UAE that was the first positioned in the mentioned article.</p>
<p>Now that we know the countries that have been receiving many immigrants, let’s see some countries that have been loosing residents during the past years. The World Bank has an indicator that shows the net output of people for a given country. The math is straightforward, it’s immigrants minus migrants. Thus, if I classify countries from the lowest value to the highest and select the first 20, I’ll end up with the 20 countries that have lost more local residents.</p>
<p>For this analysis I’ll take the mentioned metric from 2010 to 2017, in order to consider the outflow of residents throughout some years. First, let’s take the Net Immigration Flow metric.</p>
<pre class="r"><code>net_immigration &lt;- wbstats::wb(indicator = &quot;SM.POP.NETM&quot;,
                         country = &quot;countries_only&quot;,
                         startdate = 2010,
                         enddate = 2019) %&gt;% 
  select(country, value, date)

# Dataset sample
net_immigration[sample(nrow(net_immigration),5), ]</code></pre>
<pre><code>##                       country   value date
## 1113                St. Lucia       0 2017
## 293                    Bhutan    1600 2017
## 908                   Ireland -111819 2012
## 2113                    Samoa  -14013 2017
## 313  Central African Republic -200000 2017</code></pre>
<p>Now we can adjust the dataset to sum the years gathered and classify the countries in order to take the 20 that have lost more residents during the period and plot the graph.</p>
<pre class="r"><code>net_immigration %&gt;% 
  group_by(country) %&gt;% 
  summarise(net_immigration = sum(value)) %&gt;% 
  arrange(net_immigration) %&gt;% 
  head(20) %&gt;% 
  mutate(net_immigration = net_immigration * -1,
         country = fct_reorder(country, net_immigration)) %&gt;% 
  ggplot()+
  geom_col(mapping = aes(x = country, y = net_immigration),
           fill = &quot;dark orange&quot;,
           alpha = .6)+
  scale_y_continuous(labels = scales::comma)+
  theme_graph()+
  coord_flip()+
  labs(title = &quot;Countries that had lost more residents since 2010&quot;,
       x = &quot;&quot;,
       y = &quot;Net immigration&quot;)</code></pre>
<p><img src="/posts/2020-01-20-imigration-data-analysis_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p>I was expecting to see Syria and Venezuela in this plot. India and China isn’t in the same scenario of those two countries, but with their large population, any movement in theses countries are a big thing when we don’t normalize the data. In order to remove these big countries, let’s remake this analysis but now classifing countries considering the share of the population that migrated from it. For this, we’ll need to bring the same Net Immigration Flow metric and join with poplational data in the last year of analysis.</p>
<pre class="r"><code># Net immigration summed during the period
net_immigration %&gt;% 
  group_by(country) %&gt;% 
  summarise(net_immigration = sum(value)) -&gt; net_immigration

# Joinning the population and net_immigration data
population %&gt;% 
  filter(date == 2015) %&gt;%
  mutate(population = value) %&gt;% 
  select(country, population) %&gt;% 
  inner_join(net_immigration, by = c(&quot;country&quot; = &quot;country&quot;)) %&gt;% 
  mutate(net_immigration_share = round(net_immigration/population, digits = 4)) %&gt;% 
  arrange(net_immigration_share) %&gt;% 
  head(20) %&gt;% 
  mutate(net_immigration_share = net_immigration_share * -1,
         country = fct_reorder(country, net_immigration_share)) %&gt;% 
  ggplot()+
  geom_col(mapping = aes(x = country, y = net_immigration_share),
           fill = &quot;dark orange&quot;,
           alpha = .6)+
  scale_y_continuous(labels = scales::percent)+
  theme_graph()+
  coord_flip()+
  labs(title = &quot;Share of population that left the country in the period&quot;,
       x = &quot;&quot;,
       y = &quot;&quot;,
       caption = &quot;From 2010 to 2017&quot;)</code></pre>
<p><img src="/posts/2020-01-20-imigration-data-analysis_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<p>This analysis seems pretty realistic, having Syria in the first place and Puerto Rico with its social problems with gangs and organized crime.</p>
<p>Moving forward, know that we know what countries are loosing their residents, let’s analyze how remitances are impacting these countries. As noted at The Economist’s reports, remitance is a great source of investment for poor countries, because it goes straight to the hands of the family that are in need of it and is less likely to be drained by corruption.</p>
<p>Two findings in the research made by the magazine called my attention. The first is that remitance represents more thant 10% of GDP in 29 countries (that’s a huge contribution). The second discovery is that remitance is acyclic with Per Capita GDP. Thus it moves in opposite direction of this indicator and this behavior has a theory to justify it.</p>
<p>When immigrants realize that their home country are in trouble, like an economic crises or a war, they sent more money to their families in order to support them in a new tough situation. This seems well justified, but we can verify this hypothesis (i.e. if remitance is acyclic when compared with Per Capita GDP). Fortunately, Word Bank has the necessary data to analyze this hypothesis.</p>
<p>Let’s first visualize the countries that have more than 10% of their GDP comming from remitances. Luckly, World Bank has this specific metric ready to be requested by the API. The following list represent the countries and their share of GDP comming from remitances.</p>
<pre class="r"><code>remitances_over_gdp &lt;- wbstats::wb(indicator = &quot;BX.TRF.PWKR.DT.GD.ZS&quot;,
                         country = &quot;countries_only&quot;)

remitances_over_gdp %&gt;% 
  filter(date == &quot;2018&quot;,
         country != &quot;Lesotho&quot;,
         value &gt; 10) %&gt;%
  mutate(remitance_over_gdp = paste(round(value,digits = 0),&quot;%&quot;,sep = &quot;&quot;)) %&gt;% 
  arrange(desc(value)) %&gt;% 
  select(date, country, remitance_over_gdp)</code></pre>
<pre><code>##    date                country remitance_over_gdp
## 1  2018                  Tonga                41%
## 2  2018        Kyrgyz Republic                33%
## 3  2018                  Haiti                33%
## 4  2018             Tajikistan                29%
## 5  2018                  Nepal                29%
## 6  2018            El Salvador                21%
## 7  2018               Honduras                20%
## 8  2018                  Samoa                18%
## 9  2018     West Bank and Gaza                17%
## 10 2018                Moldova                16%
## 11 2018                Jamaica                16%
## 12 2018                 Kosovo                16%
## 13 2018             Uzbekistan                15%
## 14 2018       Marshall Islands                14%
## 15 2018                Liberia                14%
## 16 2018                Comoros                14%
## 17 2018            Gambia, The                12%
## 18 2018            Yemen, Rep.                12%
## 19 2018                Lebanon                12%
## 20 2018              Guatemala                12%
## 21 2018                Armenia                12%
## 22 2018             Cabo Verde                12%
## 23 2018                Georgia                12%
## 24 2018              Nicaragua                11%
## 25 2018                Ukraine                11%
## 26 2018             Montenegro                11%
## 27 2018                 Jordan                11%
## 28 2018 Bosnia and Herzegovina                11%
## 29 2018            Philippines                10%
## 30 2018       Egypt, Arab Rep.                10%
## 31 2018                Senegal                10%</code></pre>
<p>Now, let’s analyze the hypothesis that the remitance is acyclic when compared with Per Capita GDP. For this test, I’ll select the following countries: Suriname, Somalia, Sierra Leone, Senegal, Sudan, Rwanda, Nepal, Niger, Malawy, Mali, Lybia, Kenya, Ethiopia, Eritrea and Congo.</p>
<p>Now I’ll request the metric “Remitances received” and “Per Capita GDP”.</p>
<p>Know I have remitances received and Per Capita GDP. In order to compare, it’ll be necessary to normalize remitances by country population. The following code chunk will do this task.</p>
<pre class="r"><code>remitances_received %&gt;% 
  mutate(remitances = value) %&gt;% 
  select(date, country, remitances) %&gt;% 
  filter(country %in% country_view,
         date &gt; 2010) %&gt;% 
  inner_join(population, by = c(&quot;date&quot; = &quot;date&quot;, &quot;country&quot; = &quot;country&quot;)) %&gt;% 
  select(date, country, remitances, value) %&gt;% 
  mutate(remitances_adj = round(remitances/value, digits = 4)) %&gt;% 
  select(date, country, remitances_adj) -&gt; remitances

# Sample from dataset
remitances[sample(nrow(remitances),5), ]</code></pre>
<pre><code>##     date              country remitances_adj
## 46  2011              Nigeria       126.6354
## 58  2015               Rwanda        14.0029
## 1   2016          Congo, Rep.         1.5468
## 103 2018             Tanzania         7.3317
## 93  2012 Syrian Arab Republic        79.3708</code></pre>
<p>Know, I can join the two datasets and generate the scaterplot. The remitances dataset created before is already filtered with the selected countries.</p>
<pre class="r"><code>gdp_pc %&gt;% 
  mutate(gdp_pc = value) %&gt;% 
  select(date, country, gdp_pc) %&gt;% 
  inner_join(remitances, by = c(&quot;date&quot; = &quot;date&quot;, &quot;country&quot; = &quot;country&quot;)) %&gt;% 
  ggplot()+
  geom_point(mapping = aes(x = remitances_adj, y = gdp_pc))+
  geom_smooth(mapping = aes(x = remitances_adj, y = gdp_pc),
              method = &quot;lm&quot;,
              formula = y ~ x,
              se = F,
              lty = 2,
              color = &quot;dark orange&quot;)+
  theme_graph()+
  labs(title = &quot;Per Capita GDP and Remitances correlation&quot;,
       y = &quot;Per Capita GDP&quot;,
       x = &quot;Per Capita Remitances&quot;)</code></pre>
<p><img src="/posts/2020-01-20-imigration-data-analysis_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<p>I was expecting to see a negative correlation between the variables, because the lower Per Capita GDP, highet should be Per Capita Remitances. Let’s see the regression model for this two variables. The model that I’ll use will be:</p>
<p><span class="math display">\[R = \beta_0 + \beta_1 pc.gdp + \mu\]</span>
In other words, I’ll analyze the impact that per capita GDP causes in the flow of per capita remitances sent by immigrants to their families or friends. Unfortunately <span class="math inline">\(\beta_2\)</span> will be positive (contraty to what I was expecting), but eventhouth I’ll keep the model development.</p>
<pre class="r"><code>gdp_pc %&gt;% 
  mutate(gdp_pc = value) %&gt;% 
  select(date, country, gdp_pc) %&gt;% 
  inner_join(remitances, by = c(&quot;date&quot; = &quot;date&quot;, &quot;country&quot; = &quot;country&quot;)) %&gt;%
  lm(formula = remitances_adj ~ gdp_pc) %&gt;% 
  summary()</code></pre>
<pre><code>## 
## Call:
## lm(formula = remitances_adj ~ gdp_pc, data = .)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -109.41  -33.61  -25.80   35.76  240.26 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) 23.911203  10.341743   2.312   0.0225 *  
## gdp_pc       0.030089   0.006127   4.911    3e-06 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 66.44 on 116 degrees of freedom
## Multiple R-squared:  0.1721, Adjusted R-squared:  0.165 
## F-statistic: 24.11 on 1 and 116 DF,  p-value: 3.002e-06</code></pre>
<p>With the output of the model we can reformulate the regression equation:</p>
<p><span class="math display">\[R = 23.91 + 0.03 pc.gdp + \mu\]</span></p>
<p>Both intercept and slope are statistically significant with a p-value lower than 5%. Let’s summarize the both metric and see a time series of them in order to identify the mentioned pattern.</p>
<pre class="r"><code>gdp_pc %&gt;% 
  mutate(gdp_pc = value) %&gt;% 
  select(date, country, gdp_pc) %&gt;% 
  inner_join(remitances, by = c(&quot;date&quot; = &quot;date&quot;, &quot;country&quot; = &quot;country&quot;)) %&gt;%
  group_by(date) %&gt;% 
  summarise(gdp = sum(gdp_pc),
            remitance = sum(remitances_adj)) %&gt;% 
  ggplot()+
  geom_line(mapping = aes(x = date, y = gdp, group = 1),
            color = &quot;dark orange&quot;)+
  scale_y_continuous(labels = scales::comma)+
  theme_graph()+
  labs(title = &quot;Per Capita GDP time series&quot;)</code></pre>
<p><img src="/posts/2020-01-20-imigration-data-analysis_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<pre class="r"><code>gdp_pc %&gt;% 
  mutate(gdp_pc = value) %&gt;% 
  select(date, country, gdp_pc) %&gt;% 
  inner_join(remitances, by = c(&quot;date&quot; = &quot;date&quot;, &quot;country&quot; = &quot;country&quot;)) %&gt;%
  group_by(date) %&gt;% 
  summarise(gdp = sum(gdp_pc),
            remitance = sum(remitances_adj)) %&gt;% 
  ggplot()+
  geom_line(mapping = aes(x = date, y = remitance, group = 1),
            color = &quot;dark orange&quot;)+
  scale_y_continuous(labels = scales::comma)+
  theme_graph()+
  labs(title = &quot;Per Capita Remitances time series&quot;)</code></pre>
<p><img src="/posts/2020-01-20-imigration-data-analysis_files/figure-html/unnamed-chunk-15-2.png" width="672" /></p>
<p>When the data is agregated, the behavior is perceived. I won’t go deep in this topic because it would miss the point.</p>
</div>
<div id="conclusions" class="section level2">
<h2><strong>Conclusions</strong></h2>
<p>In this post I wanted analyze some data about immigration, share the main findings of the research made by the magazine and show how to request some data from World Bank using the <strong>wbstats</strong> package. I hope it was interesting for you.</p>
</div>
]]></content>
        </item>
        
        <item>
            <title>Connecting R on Amazon Redshift Database</title>
            <link>/posts/2019/10/connecting-r-on-amazon-redshift-database/</link>
            <pubDate>Mon, 28 Oct 2019 00:00:00 +0000</pubDate>
            
            <guid>/posts/2019/10/connecting-r-on-amazon-redshift-database/</guid>
            <description>IntroductionIn this tutorial I’ll show a step by step on how to access Amazon Redshift Database throughout R. This task will be very useful if you prefer to use R intead of the traditional Excel to execute exploratory data analysis on your company. The goal of this tutorial is to access the database from R, bring a data.frame as a result set and then create your analysis.
Step 1Dowload the JDBC driver from Amazon.</description>
            <content type="html"><![CDATA[


<div id="introduction" class="section level2">
<h2><strong>Introduction</strong></h2>
<p>In this tutorial I’ll show a step by step on how to access Amazon Redshift Database throughout R. This task will be very useful if you prefer to use R intead of the traditional Excel to execute exploratory data analysis on your company. The goal of this tutorial is to access the database from R, bring a data.frame as a result set and then create your analysis.</p>
</div>
<div id="step-1" class="section level2">
<h2><strong>Step 1</strong></h2>
<p>Dowload the JDBC driver from Amazon. This file will be needed to allow the connection of one tool (i.e. R Studio) to the Amazon cluster that you have access. In this <a href="https://docs.aws.amazon.com/pt_br/redshift/latest/mgmt/configure-jdbc-connection.html#obtain-jdbc-url">link</a> there’s the files indicated for each version of the JDBC.</p>
<p>Ps: If at the end of the role process the database access fail, take a look on the above file that you dowloaded to see if it came corrupted. This can be caused (not likely but it can) when the dowload is made directly from R.</p>
</div>
<div id="step-2" class="section level2">
<h2><strong>Step 2</strong></h2>
<p>Inside R Studio, install and call the following packages: “rJava” and “RJDBC”.</p>
<pre class="r"><code>install.packages(&quot;rJava&quot;)
install.packages(&quot;RJDBC&quot;)

library(rJava)
library(RJDBC)</code></pre>
</div>
<div id="step-3" class="section level2">
<h2><strong>Step 3</strong></h2>
<p>Create a variable (i.e. “driver”) that will contain the JDBC file that was dowloaded on the Step 1. Use the following code for this step:</p>
<pre class="r"><code>driver &lt;- JDBC(driverClass = &quot;com.amazon.redshift.jdbc41.Driver&quot;, 
               classPath = Sys.glob(&quot;caminho do arquivo/RedshiftJDBC41-1.1.9.1009.jar&quot;), 
               identifier.quote=&quot;`&quot;)</code></pre>
</div>
<div id="step-4" class="section level2">
<h2><strong>Step 4</strong></h2>
<p>Create a variable (i.e. “db_connection”) that will indicate the information of the database to be accessed by R Studio. Use the following code for this step:</p>
<pre class="r"><code>db_connection &lt;- sprintf(&quot;jdbc:redshift://%s:%s/%s?tcpKeepAlive=true&amp;ssl=true&amp;sslfactory=com.amazon.redshift.ssl.NonValidatingFactory&quot;, 
                         &quot;host of the database&quot;, 
                         &quot;port&quot;, 
                         &quot;database name&quot;)</code></pre>
</div>
<div id="step-5" class="section level2">
<h2><strong>Step 5</strong></h2>
<p>Create a variable (i.e. “access”) that will contain the information of the database and also the user that will access the database. Use the following code for this step:</p>
<pre class="r"><code>access &lt;- dbConnect(driver, db_end, &quot;user&quot;, &quot;password&quot;)</code></pre>
<p>Ps: Note that the funcion “dbConnect” used the database access file driver, the information of the database that will be accessed and the information of the user that will access the database.</p>
</div>
<div id="step-6" class="section level2">
<h2><strong>Step 6</strong></h2>
<p>After the creation of the necessary variables, to access the database it’ll be necessary the last one created (at step 5). To access the database, the package RJDBC will be used. Some examples can be seeing on the code chunck that follows:</p>
<p>Ps: Queries run on R Studio console must by with quotes.</p>
<pre class="r"><code>RJDBC::dbGetQuery(jconn,
                  &quot;select 
                     order
                   , client
                   , sale_date 
                  from orders_tb 
                  limit 10&quot;)</code></pre>
</div>
<div id="step-7" class="section level2">
<h2><strong>Step 7</strong></h2>
<p>To explore the feature in depth, it’s interesting that, intead of writing the query on the R Studio console, you save your query in a file (.sql) and make R access this file and save it as a variable (i.e. “sql_file”). To do this, it’s necessary to install and call the “readr” package.</p>
<pre class="r"><code>install.packages(&quot;readr&quot;)

library(readr)

-- Saving the .sql file as a variable
sql_file &lt;- readr::read_file(&quot;path_of_the_file/script.sql&quot;)

-- Using the .sql file to access Redshift database
query_redshift &lt;- RJDBC::dbGetQuery(jconn, sql_file)</code></pre>
</div>
<div id="final-step-plus" class="section level2">
<h2><strong>Final step (plus)</strong></h2>
<p>Sometimes you can have projects that demand more than one query, thus you will need many .sql files in order to run each query. But there’s a solution to make things simpler. You can save many queries on the same .sql file and separate each query by a string (i.e. –query_1_being, –query_1_end, –query_2_begin, –query_2_end, and so on). Then, you can use regexp to split your file and create variables for each query. The regexp will access the defined query and execute the split to create the variable with just one query code. For this step, you will need to install and call the “stringr” package.</p>
<pre class="r"><code>install.packages(&quot;stringr&quot;)

library(stringr)

-- saving the .sql file as a variable
sql_syntax &lt;- readr::read_file(&quot;.sql_file_path.all_queries.sql&quot;)

-- creating one variable with the first query of the .sql file
query_1 &lt;- 
  RJDBC::dbGetQuery(jconn, 
                    substr(sql_syntax, 
                           min(stringr::str_locate(string = sql_syntax, &#39;-- query.1.begin&#39;)), 
                           max(stringr::str_locate(string = sql_syntax, &#39;-- query.1.end&#39;))))

query_2 &lt;- 
  RJDBC::dbGetQuery(jconn, 
                    substr(sql_syntax, 
                           min(stringr::str_locate(string = sql_syntax, &#39;-- query.2.begin&#39;)), 
                           max(stringr::str_locate(string = sql_syntax, &#39;-- query.2.end&#39;))))</code></pre>
</div>
<div id="conclusion" class="section level2">
<h2><strong>Conclusion</strong></h2>
<p>This tutorial was aimed to show how simple it is to access Amazon Redshift database throughout R Studio. It’s an excellent alternative when you want to perform robust exploratory data analysis (where Excel will let you down).</p>
</div>
<div id="more-tutorials-on-the-subject" class="section level2">
<h2><strong>More tutorials on the subject</strong></h2>
<p><a href="https://www.progress.com/tutorials/jdbc/connecting-to-amazon-redshift-from-r-via-jdbc-driver">Connecting to Amazon Redshift from R</a></p>
<p><a href="https://www.r-bloggers.com/a-comprehensive-guide-to-connect-r-to-amazon-redshift/">A comprehensive guide to connect R to Amazon Redshift</a></p>
</div>
]]></content>
        </item>
        
        <item>
            <title>Residual analysis in econometric models</title>
            <link>/posts/2019/09/residual-analysis-in-econometric-models/</link>
            <pubDate>Thu, 05 Sep 2019 00:00:00 +0000</pubDate>
            
            <guid>/posts/2019/09/residual-analysis-in-econometric-models/</guid>
            <description>The linear regression model is highly used on the prediction of continuous variables, where is one or more independent variables and one dependent one (the one that it seeks to test an hypothesis about its behavior). This is a pretty simple model to by executed and one of the firsts to be taught in econometric classes. Although its simplicity, in order to reach reliable results, some assumptions are needed, like the following:</description>
            <content type="html"><![CDATA[


<p>The linear regression model is highly used on the prediction of continuous variables, where is one or more independent variables and one dependent one (the one that it seeks to test an hypothesis about its behavior). This is a pretty simple model to by executed and one of the firsts to be taught in econometric classes. Although its simplicity, in order to reach reliable results, some assumptions are needed, like the following:</p>
<ol style="list-style-type: lower-roman">
<li><p>Absence of multicolineatiry between independent variables.</p></li>
<li><p>Absence of autocorrelation on the dependent variable.</p></li>
<li><p>Absence of pattern on the behavior of the model residuals, in other words, absence of heteroscedasticity.</p></li>
<li><p>Normal distribution of residuals.</p></li>
</ol>
<p>Having this assumptions satisfied, the model can be executed and the generated conclusions will be reliable to allow decision making. In this post, I’ll analyse the behavior of the residuals for a linear regression model in order to validate the assumptions (iii) and (iv). For this, I’ll use a data set that presents the price of suggarcane as independent variable and the planted area of this product, that will be the dependent variable.</p>
<p>The goal of this example is to analyse, through a simple linear regression model, the suggarcane supply elasticity as a function of the suggarcane price. The hipothesis is that there’s elasticity on the supply, thus the planted area increases in responde to a price increase. But, in order to validade this existence, it’s necessary to check, using a regression model, that these two variables have correlation. Then, the assumptions (iii) and (iv) will support this conclusion.</p>
<p>For this example, I’ll utilize the following R packages:</p>
<pre class="r"><code>library(tidyverse)
library(lmtest)
library(corrplot)
library(readxl)

theme_graph &lt;- function(){
  theme(
    plot.title = element_text(size = 16),
    plot.subtitle = element_text(size = 12),
    plot.caption = element_text(face = &quot;italic&quot;, size = 9),
    axis.text = element_text(size = 9),
    axis.title = element_text(face = &quot;italic&quot;, size = 9),
    strip.background = element_rect(fill = &quot;grey&quot;),
    strip.text = element_text(face = &quot;bold&quot;),
    legend.title = element_blank(),
    legend.position = &quot;bottom&quot;
  )
}
  
graph_color &lt;- &quot;#006666&quot;</code></pre>
<p>The data set for this example has 34 rows, with planted area and suggarcane price fields.</p>
<pre class="r"><code># Getting the dataset
dados &lt;- readxl::read_excel(&quot;C:/Users/francisco.piccolo/Desktop/R/franciscopiccolo.github.io/datasets/Econometria_exercicios/autocorrelacao_cana_de_acucar.xlsx&quot;)

# Chaging the name of the fields to remove blank spaces
dados %&gt;% 
  transmute(period = Período,
            area = Área,
            price = `Preço da Cana de Açúcar`*100) -&gt; df</code></pre>
<p>Lets see a sample of this dataset.</p>
<pre class="r"><code>df[sample(nrow(df),5), ] %&gt;%
    as.tibble()</code></pre>
<pre><code>## # A tibble: 5 x 3
##   period  area price
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     28   152  40.5
## 2     13   125  19.4
## 3     27    97  40.1
## 4     34   235  39.2
## 5     12    80  14.6</code></pre>
<p>The linear regression model proposed for this problem is defined by the following equation:</p>
<p><span class="math display">\[ lnY_t = \beta_0+\beta_1 (lnX_t) + \mu_t \]</span></p>
<p>Where:</p>
<p><span class="math inline">\(Y_t\)</span> = planted area, natural log transformed</p>
<p><span class="math inline">\(X_t\)</span> = suggarcane price, natural log transformed</p>
<p><span class="math inline">\(\beta_0\)</span> = intercept</p>
<p><span class="math inline">\(\beta_1\)</span> = slope</p>
<p><span class="math inline">\(\mu_t\)</span> = residuals</p>
<p>The natural log is used to in order to have variations between periods interpreted as percentual variation. This assumption is made possible only for natural log transformations and this adjustment is needed in problems invonving elasticity, because elasticity is interpreted as a percentual variation in one variable given a percentual variation in another variable.</p>
<p>The following graph shows the behavior of the studied variables and the regression line.</p>
<pre class="r"><code>df %&gt;% 
  ggplot()+
  geom_point(mapping = aes(x = price, y = area), shape = 20)+
  geom_smooth(mapping = aes(x = price, y = area), 
              method = &quot;lm&quot;, 
              formula = y ~ x, 
              se = F, 
              lty = 2,
              color = &quot;dark orange&quot;)+
  theme_graph()+
  labs(title = &quot;Dispersion graph for the model&quot;)</code></pre>
<p><img src="/posts/2019-09-05-residual-analysis-in-econometric-models_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>In order to develop the model using the log transformation, there’re two options:</p>
<ol style="list-style-type: lower-roman">
<li><p>Adjust the variables on the dataset and build the normal using the new variables generated by the log scale calculation.</p></li>
<li><p>Use the original dataset and inform adjust the model to apply the transformation on the variables before calculating the parameters.</p></li>
</ol>
<p>Lets see each one of theses methods to confirm they’re equal:</p>
<p><strong>(i) </strong></p>
<pre class="r"><code>df %&gt;% 
  mutate(area_log = log(area),
         price_log = log(price)) %&gt;% 
  lm(formula = area_log ~ price_log) %&gt;% 
  summary()</code></pre>
<pre><code>## 
## Call:
## lm(formula = area_log ~ price_log, data = .)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -0.65076 -0.18823 -0.03096  0.24914  0.60492 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   1.6416     0.3534   4.645 5.56e-05 ***
## price_log     0.9706     0.1106   8.773 5.03e-10 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.3088 on 32 degrees of freedom
## Multiple R-squared:  0.7063, Adjusted R-squared:  0.6972 
## F-statistic: 76.97 on 1 and 32 DF,  p-value: 5.031e-10</code></pre>
<p><strong>(ii)</strong></p>
<pre class="r"><code>df %&gt;% 
  lm(formula = log(area) ~ log(price)) %&gt;% 
  summary()</code></pre>
<pre><code>## 
## Call:
## lm(formula = log(area) ~ log(price), data = .)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -0.65076 -0.18823 -0.03096  0.24914  0.60492 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   1.6416     0.3534   4.645 5.56e-05 ***
## log(price)    0.9706     0.1106   8.773 5.03e-10 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.3088 on 32 degrees of freedom
## Multiple R-squared:  0.7063, Adjusted R-squared:  0.6972 
## F-statistic: 76.97 on 1 and 32 DF,  p-value: 5.031e-10</code></pre>
<p>As indicated, the two alternatives generate the same result. It’s up to the researcher to choose the method. The regression model generated is:</p>
<p><span class="math display">\[\hat{Y} = 1.6416 + 0.9706X_1 + \mu\]</span>
With both intercept and slope statistically significant given their low p-value.</p>
<p>The r² reach 70.6%, but this isn’t enough to make conclusions about the model. Its necessary to analyse the model hypothesis about the residuals to ensure that the model is reliable. The following code return the residuals from a ‘lm’ model.</p>
<pre class="r"><code>model_residuals &lt;- 
  data.frame(values = df %&gt;% 
                        lm(formula = log(area) ~ log(price)) %&gt;% 
                        residuals())</code></pre>
<p>The next graph shows the residuals distribution in order to validate if they’re normally distributed. Both histogram and quantil-quantil plot are good choices to validate this assumption.</p>
<pre class="r"><code># Histogram
model_residuals %&gt;% 
  ggplot()+
  geom_histogram(mapping = aes(x = values), fill = &quot;dark orange&quot;, alpha = .5)+
  theme_graph()+
  labs(title = &quot;Residuals Distribution&quot;,
       x = &quot;&quot;,
       y = &quot;&quot;)</code></pre>
<p><img src="/posts/2019-09-05-residual-analysis-in-econometric-models_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<pre class="r"><code># q-q plot
model_residuals %&gt;% 
  ggplot()+
  geom_qq(mapping = aes(sample = values))+
  theme_graph()+
  labs(title = &quot;Residuals&#39; Q-Q plot&quot;,
       x = &quot;&quot;,
       y = &quot;&quot;)</code></pre>
<p><img src="/posts/2019-09-05-residual-analysis-in-econometric-models_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p>Both graphs enforce the ideia that the model’s residuals are normally distributed. But in order to make a conclusion, sometimes a formal test will be necessary. For this problem, we’ll use the Durbin Watson test. This test can be performed using the following code.</p>
<pre class="r"><code>lmtest::dwtest(df %&gt;% 
                 lm(formula = log(area) ~ log(price)))</code></pre>
<pre><code>## 
##  Durbin-Watson test
## 
## data:  df %&gt;% lm(formula = log(area) ~ log(price))
## DW = 1.2912, p-value = 0.009801
## alternative hypothesis: true autocorrelation is greater than 0</code></pre>
<p>The test generate the value of 1.2912, but only this value isn’t enough to make the conclusion. As well as the DW value, DL and DU intervals are necessary. These values can be found at this <a href="http://www.portalaction.com.br/analise-de-regressao/33-diagnostico-de-independencia">table</a>. In order to find them, take the number of observations of the dataset (n = 33), the significance level of your test (i.e. 0.05) and the degress of freedom (i.e. 1). Thus we have:</p>
<p><strong>DL</strong> = 1.35</p>
<p><strong>DU</strong> = 1.49</p>
<p>With a DW of 1.2912, above 0 and under the DL value, we can conclude that the residuals are independent.</p>
<p>To conclude, both graphs and formal tests confirmed that the residuals are independent and then we have the hypothesis of the model satisfied, allowing inferences about the problem being studies, in this case, the elasticity of the suggarcane supply given it’s price variability.</p>
]]></content>
        </item>
        
    </channel>
</rss>
