---
title: ""
date: 2019-12-29
output:
  prettydoc::html_pretty:
    theme: architect
---

```{r,eval=T,include=T,warning=F,message=F,echo=T}
library(tidyverse)
library(ggthemes)
library(quantmod)
library(zoo)
library(gridExtra)
library(purrr)
library(tidyquant)
library(sqldf)

theme_set(theme_few())
```

```{r, eval=F,message=F,warning=F,echo=F,include=F}
# Todos os símbolos salvos em um arquivo txt
symbols_1 <- data.frame(read.table("C:/Users/francisco.piccolo/Desktop/R/symbols_yahoo_1.txt",sep = " "))

# Pegando apenas ações preferenciais (tipo 3 ou sem número)
symbols_1 %>% 
  mutate(
    symbols = V2,
    stock_type = stringr::str_extract(V2,"\\(?[0-9,.]+?"),
    classification = ifelse(stock_type == ".","follow",
                            ifelse(stock_type == 3,"follow",
                                   "dont_follow"))
  ) %>% 
  filter(classification == "follow") %>% 
  select(symbols) -> symbols

# Transformando os símbolos em character para poder fazer a busca
symbols <- as.character(symbols[,1])

# Indicando quantos dias "para traz" serão analisados
days_before <- 900

tq_get(symbols,
       get = "stock.prices",
       from = Sys.Date()-days_before,
       to = Sys.Date()) %>%
  arrange(date) -> stock_monitor
```

```{r, eval=T,message=F,warning=F,echo=F,include=F}
#readr::write_rds(stock_monitor,"C:/Users/francisco.piccolo/Desktop/R/franciscopiccolo.github.io/base_de_dados/Stock Monitoring/stock_monitor.RDS")

readr::read_rds("C:/Users/francisco.piccolo/Desktop/R/franciscopiccolo.github.io/base_de_dados/Stock Monitoring/stock_monitor.RDS") -> stock_monitor
```

```{r, eval=T,include=T,warning=F,message=F}
# SQL para tratar os dados extraídos do yahoo.finance
sql_syntax <- readr::read_file('C:/Users/francisco.piccolo/Desktop/R/stock_monitoring_sql_adjustment.sql')

df_stock_monitor <- sqldf::sqldf(sql_syntax)
```

Script SQL para tratar os dados.

```{sql,eval=F,include=T}
select
	  symbol
	, date
	, volume
	, close
	, first_price
	, last_day_price
	, avg_price
	, avg_price_3_days
	, price_delta
	, price_delta_last_day
	, avg_price_group
	, rn
	, days_aft_oppend
from (
	select
		  symbol
		, date
		, volume
		, close
		, first_price
		, last_day_price
		, avg_price
		, avg_price_3_days
		, price_delta
		, price_delta_last_day
		, case 
			when avg_price <= 20 then 20
			when avg_price <= 40 then 40
			when avg_price <= 60 then 60
			when avg_price <= 80 then 80
			when avg_price <= 100 then 100
			else 101
		end as avg_price_group
		, rn
		, max(rn) over (partition by symbol) as days_aft_oppend
	from (
		select
			  symbol
			, date
			, volume
			, close
			, first_value(close) over (partition by symbol order by date asc) as first_price
			, lag(close,1) over (partition by symbol order by date asc) as last_day_price
			, avg(close) over (partition by symbol order by date asc rows between unbounded preceding and unbounded following) as avg_price
			, avg(close) over (partition by symbol order by date asc rows between 2 preceding and current row) as avg_price_3_days
			, round((close/first_value(close) over (partition by symbol order by date asc))-1,4) as price_delta
			, round((close/lag(close,1) over (partition by symbol order by date asc))-1,4) as price_delta_last_day
			, row_number() over (partition by symbol order by date desc) as rn
		from stock_monitor
		where 1=1
		and symbol in 
			(
			select
				symbol
			from (
				select
					  symbol
					, volume
					, row_number() over (partition by symbol order by date desc) as rn	
				from stock_monitor
				)
			where 1=1
			and rn = 1
			and volume > 10000
			)
		)
	)
where 1=1
and days_aft_oppend >= 365
;
```

### Ibovespa

```{r,eval=T,include=T,echo=T,warning=F,message=F}
tq_get("^BVSP",
       get = "stock.prices",
       from = Sys.Date()-2000,
       to = Sys.Date()) %>%
  arrange(date) -> ibov

ibov %>% 
  ggplot(aes(x = date, y = close, group = 1))+
  geom_line(color = "#5BA98F", fill = "#7EC6AE", size = 1)+
  scale_y_continuous(labels = scales::comma)+
  labs(
    x = "",
    y = ""
  )
```

### Quantidade de ações sendo monitoradas

Apenas ações que possuem volume negociado acima de 10.000 no último pregão e que estão sendo negociadas há pelo menos 1 ano.

```{r,eval=T,include=T,warning=F,message=F}
df_stock_monitor %>% 
  distinct(symbol) %>% 
  nrow()
```

### Distribuição do preço das ações do último pregão

```{r,eval=T,include=T,echo=T,warning=F,message=F}
df_stock_monitor %>% 
  filter(symbol != "^BVSP",
         rn == 1) %>% 
  ggplot(aes(x=close,fill="red"))+
  geom_density(binwidth = .05,alpha = .5)+
  scale_x_log10()+
  theme(
    legend.title = element_blank(),
    legend.position = "none"
  )
```

## Variação no preço das ações no período

### Distribuição da variação do preço ao longo do período

```{r,eval=T,include=T,warning=F,message=F,echo=T}
df_stock_monitor %>% 
  filter(rn == 1) %>% 
  ggplot(aes(x=price_delta))+
  geom_histogram(binwidth = .1,alpha=.5,fill="#409736")+
  geom_vline(xintercept = 0)+
  scale_x_continuous(labels = scales::percent)+
  labs(
    title = "Distribuição dos deltas do período",
    subtitle = "Maioria das ações valorizou no período analisado",
    x = "Delta percentual",
    y = "Frequência"
  )
```

### Top 50 que mais valorizaram no período

```{r,eval=T,echo=T,warning=F,message=F,include=T}
df_stock_monitor %>% 
  filter(rn == 1) %>% 
  arrange(desc(price_delta)) %>% 
  head(80) %>% 
  select(symbol,price_delta) %>% 
  mutate(price_delta_max = paste(round(price_delta, digits = 2)*100, "%",sep = ""),
         symbol_delta = paste(symbol, price_delta_max,sep = " ")) %>% 
  inner_join(df_stock_monitor, by = "symbol") %>% 
  select(symbol,symbol_delta,date,price_delta.y,price_delta_max,close,avg_price) %>% 
  filter(!is.na(close)) %>% 
  ggplot(aes(x = date, y = close))+
  geom_area(color = "#409736", fill = "#7EC6AE",alpha=.6)+
  geom_line(color = "#2B7C22", size = 1)+
  geom_hline(aes(yintercept = avg_price),lty = 2, color = "red")+
  facet_wrap(~symbol_delta,scales = "free_y")+
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    strip.text.x = element_text(size = 9,
                                face = "bold",
                                vjust = -2)
  )+
  labs(
    x = "",
    y = ""
  )
```

### Top 50 que menos valorizaram no período

```{r,eval=T,echo=T,warning=F,message=F,include=T}
df_stock_monitor %>% 
  filter(rn == 1) %>% 
  arrange(price_delta) %>% 
  head(80) %>% 
  select(symbol,price_delta) %>% 
  mutate(price_delta_max = paste(round(price_delta,digits = 2)*100,"%",sep = ""),
         symbol_delta = paste(symbol,price_delta_max,sep = " ")) %>% 
  inner_join(df_stock_monitor, by = "symbol") %>% 
  select(symbol,symbol_delta,date,price_delta.y,price_delta_max,close,avg_price) %>% 
  ggplot()+
  geom_area(aes(x = date, y = close),color = "#409736", fill = "#7EC6AE",alpha=.6)+
  geom_line(aes(x = date, y = close),color = "#2B7C22", size = 1)+
  geom_hline(aes(yintercept = avg_price),lty = 2, color = "red")+
  facet_wrap(~symbol_delta, scales = "free_y")+
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    strip.text.x = element_text(size = 9,
                                face = "bold",
                                vjust = -2)
  )+
  labs(
    x = "",
    y = ""
  )
```

### Selecionando ações para investigar se vale a pena comprar

```{r}
selected <- c("VALE3.SA","TOTS3.SA","BRAP3.SA","AGRO3.SA","POMO3.SA","TIMP3.SA","ITSA3.SA","ABEV3.SA","ATOM3.SA","BRKM3.SA","CCRO3.SA","FLRY3.SA","ITUB3.SA","KLBN3.SA","MDIA3.SA","TPIS3.SA","USIM3.SA","VIVT3.SA","VULC3.SA")

df_stock_monitor %>%
  filter(symbol %in% selected) %>% 
  ggplot(aes(x=date,y=close,group=symbol,color=symbol))+
  geom_line()
```











