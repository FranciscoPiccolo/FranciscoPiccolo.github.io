---
title: ""
date: 2019-10-20
output:
  html_document:
    df_print: paged
    theme: cerulean
    highlight: zenburn
    fig_width: 8.5
    fig_height: 4
---

##### Introduction

In this tutorial I'll show a step by step on how to access Amazon Redshift Database throughout R. This task will be very useful if you prefer use R intead on the traditional Excel to execute exploratory data analysis on your company. The goal of this tutorial is to access the database from R, bring a data.frame as a result set and then create your analysis.

##### Step 1

Dowload the JDBC driver from Amazon. This file will be needed to allow the connection of one tool (i.e. R Studio) to the Amazon cluster that you have access. In this [link](https://docs.aws.amazon.com/pt_br/redshift/latest/mgmt/configure-jdbc-connection.html#obtain-jdbc-url) there's the files indicated for each version of the JDBC.

Ps: If at the end of the role process the database access fail, take a look on the above file that you dowloaded to see if it came corrupted. This can be caused (not likely but it can) when the dowload is made directly from R.

##### Step 2

Inside R Studio, install and call the following packages: "rJava" and "RJDBC".

```{r,eval=F,include=T,message=F,warning=F}
install.packages("rJava")
install.packages("RJDBC")

library(rJava)
library(RJDBC)
```

##### Step 3

Create a variable (i.e. "driver") that will contain the JDBC file that was dowloaded on the Step 1. Use the following code for this step:

```{r,eval=F,include=T,message=F,warning=F}
driver <- JDBC(driverClass = "com.amazon.redshift.jdbc41.Driver", 
               classPath = Sys.glob("caminho do arquivo/RedshiftJDBC41-1.1.9.1009.jar"), 
               identifier.quote="`")
```

##### Step 4

Create a variable (i.e. "db_connection") that will indicate the information of the database to be accessed by R Studio. Use the following code for this step:

```{r,eval=F,include=T,message=F,warning=F}
db_connection <- sprintf("jdbc:redshift://%s:%s/%s?tcpKeepAlive=true&ssl=true&sslfactory=com.amazon.redshift.ssl.NonValidatingFactory", 
                         "host of the database", 
                         "port", 
                         "database name")
```

##### Step 5

Create a variable (i.e. "access") that will contain the information of the database and also the user that will access the database. Use the following code for this step:

```{r,eval=F,include=T,message=F,warning=F}
access <- dbConnect(driver, db_end, "user", "password")
```

Ps: Note that the funcion "dbConnect" used the database access file driver, the information of the database that will be accessed and the information of the user that will access the database.

##### Step 6

After the creation of the necessary variables, to access the database it'll be necessary the last one created (at step 5). To access the database, the package RJDBC will be used. Some examples can be seeing on the code chunck that follows:

Ps: Queries run on R Studio console must by with quotes.

```{r,eval=F,include=T,message=F,warning=F}
RJDBC::dbGetQuery(jconn,
                  "select 
                     order
                   , client
                   , sale_date 
                  from orders_tb 
                  limit 10")

RJDBC::dbGetQuery(jconn,
                  "select 
                     supplier
                   , invoice 
                  from supplier.tb 
                  where 1 = 1 
                  and delivery.date = 2019-01-30 
                  limit 10")
```

##### Step 7

Para explorar de maneira completa esta funcionalidade, é interessante que, ao invés de escrever a query no console do R, a query seja salva em um arquivo (.sql) e o R acesse este arquivo e salve-o em uma variável. Para isso, é necessário instalar e chamar o pacote readr. Após isso, o código do passo 6 será:

To explore the feature in depth, it's interesting that, intead of writing the query on the R Studio console, you save your query in a file (.sql) and make R access this file and save it as a variable (i.e. "sql_file"). To do this, it's necessary to install and call the "readr" package.

```{r,eval=F,include=T,message=F,warning=F}
install.packages("readr")

library(readr)

-- Saving the .sql file as a variable
sql_file <- readr::read_file("path_of_the_file/script.sql")

-- Using the .sql file to access Redshift database
query_redshift <- RJDBC::dbGetQuery(jconn, sql_file)
```

##### Final step (plus)

Sometimes you can have projects that demand more than one query, thus you will need many .sql files in order to run each query. But there's a solution to make things simpler. You can save many queries on the same .sql file and separate each query by a string (i.e. --query_1_being, --query_1_end, --query_2_begin, --query_2_end, and so on). Then, you can use regexp to split your file and create variables for each query. The regexp will access the defined query and execute the split to create the variable with just one query code. For this step, you will need to install and call the "stringr" package.

```{r,eval=F,include=T,message=F,warning=F}
install.packages("stringr")

library(stringr)

-- saving the .sql file as a variable
sql_syntax <- readr::read_file(".sql_file_path.all_queries.sql")

-- creating one variable with the first query of the .sql file
query_1 <- 
  RJDBC::dbGetQuery(jconn, 
                    substr(sql_syntax, 
                           min(stringr::str_locate(string = sql_syntax, '-- query.1.begin')), 
                           max(stringr::str_locate(string = sql_syntax, '-- query.1.end'))))

query_2 <- 
  RJDBC::dbGetQuery(jconn, 
                    substr(sql_syntax, 
                           min(stringr::str_locate(string = sql_syntax, '-- query.2.begin')), 
                           max(stringr::str_locate(string = sql_syntax, '-- query.2.end'))))

query_3 <- 
  RJDBC::dbGetQuery(jconn, 
                    substr(sql_syntax, 
                           min(stringr::str_locate(string = sql_syntax, '-- query.3.begin')),
                           max(stringr::str_locate(string = sql_syntax, '-- query.3.end'))))
```

##### Conclusion

This tutorial was aimed to show how simple it is to access Amazon Redshift database throughout R Studio. It's an excellent alternative when you want to perform robust exploratory data analysis (where Excel will let you down).

##### More tutorials on the subject

[Connecting to Amazon Redshift from R](https://www.progress.com/tutorials/jdbc/connecting-to-amazon-redshift-from-r-via-jdbc-driver)

[A comprehensive guide to connect R to Amazon Redshift](https://www.r-bloggers.com/a-comprehensive-guide-to-connect-r-to-amazon-redshift/)
